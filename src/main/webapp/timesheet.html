<!doctype html>
 
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Timesheet</title>
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
  <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
  <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
  <script src="jquery.sortElements.js"></script>
  <style media="screen" type="text/css">
	body {
		font-family: "Trebuchet MS", "Helvetica", "Arial",  "Verdana", "sans-serif";
		font-size: 62.5%;
		margin-left: 5%;
		margin-top: 2%;
	}

    .busy {
        color: green;
    }

	#table,td {
      padding-right:30px;
    }

    .invisible {
      visibility:hidden;
	}

    .invalid {
      color: red;
    }
    
    .links {
      color: blue;
      padding-bottom: 30px;
    }

    .link {
       float:left; 
       padding-right: 20px;
    }

    #more {
	   color:blue;
       margin-top:10px;    
	}

	.delete {
        color:blue;
    }

	#main {
      clear: both;
    }


  </style>
  <script>
  $(function() {

	var weekday=new Array(7);
	weekday[0]="Sunday";
	weekday[1]="Monday";
	weekday[2]="Tuesday";
	weekday[3]="Wednesday";
	weekday[4]="Thursday";
	weekday[5]="Friday";
	weekday[6]="Saturday";

    var settings={};
    settings.moveToNextWorkingDayAfterTime="15:00"
    settings.workingDays=[2,3,4,5];

	var theDate = new Date();
	theDate.setHours(0);
	theDate.setMinutes(0);
	theDate.setSeconds(0);
	theDate.setMilliseconds(0);


    function formattedDate() {
     var dd = theDate.getDate();
	 var mm = theDate.getMonth()+1; //January is 0!
	 var yyyy = theDate.getFullYear();
	 if(dd<10){dd='0'+dd} 
	 if(mm<10){mm='0'+mm} 
	 return dd+'/'+mm+'/'+yyyy;
    }

	function formattedDateWithDay() {
	 var theDateFormatted = weekday[theDate.getDay()] + ' '+ formattedDate();
	 return theDateFormatted;
	}

	function updateDate() {
	 $("#date").text(formattedDateWithDay());
	}

	function nextDate() {
	 theDate.setDate(theDate.getDate() +1);
	 updateDate();
	}

	function previousDate() {
	 theDate.setDate(theDate.getDate() -1);
	 updateDate();
	}

    function orderedFormat(date) {
      return date.substring(6,8) + date.substring(3,5) + date.substring(0,2);
    }

    function guid() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
        return v.toString(16);
      });
    }

    function refresh() {
        $("#working").toggleClass("invisible");
		$("#times").empty();
        setTimeout(function () {
			  submitTime("08301200");
			  submitTime("13001730");
			  submitTime("08001300");
			  submitTime("14001645");
              $("#working").toggleClass("invisible");
		  },1000);
    }

    $("#refresh").click(refresh);

	function submitTime(s) {
       var hh1 = s.substring(0,2);
       var mm1 = s.substring(2,4);
       var hh2 = s.substring(4,6);
       var mm2 = s.substring(6,8);
	   var valid = s.length==8 && 
                   parseInt(hh1)>=0 && parseInt(hh1) <=23 && 
                   parseInt(mm1)>=0 && parseInt(mm1) <=59 && 
                   parseInt(hh2)>=0 && parseInt(hh2)<=23 &&
                   parseInt(mm2)>=0 && parseInt(mm2) <=59 && 
				   parseInt(hh1)*60+parseInt(mm1) < parseInt(hh2)*60+parseInt(mm2); 
	  var cls = valid ? "busy" :"invalid";
      var msg = valid ? "Saving..." : "Invalid";
      var deleteClass = valid ? "invisible" :"delete";
      var rowId = guid();
 	   $('#times').append(
			'<tr id="'+ rowId + '">'+
			'<td>' + weekday[theDate.getDay()] + '</td>'+
			'<td>'+ formattedDate() +'</td>'+ 
			'<td>'+ hh1 + ':' + mm1 + '</td>'+
			'<td>'+ hh2 + ':' + mm2 + '</td>'+
			'<td><div id="delete'+rowId+'" class="'+deleteClass+'">Delete</div></td>'+
			'<td id="msg'+rowId+'" class="'+cls+'">'+msg+'</td>'+
			'</tr>');
	   //define delete action
	   $("#delete"+rowId).click(function (){
           $("#msg"+rowId).html("Deleting...");
		   $("#delete"+rowId).toggleClass("invisible");
		   if (!valid) {
			 setTimeout(function () {$("#"+rowId).remove();},1000);
		   }
           else {
			 //TODO call delete service
             setTimeout(function () {$("#"+rowId).remove();},1000);
		   } 
       });
	   sortTable();
	   $("#time-range").val('');

	   if (valid && (hh2+':'+mm2)>=settings.moveToNextWorkingDayAfterTime) {
         nextDate();
		 while ($.inArray(theDate.getDay(),settings.workingDays)==-1)
           nextDate();
       }

	   //do ajax save call
       if (valid) {
           setTimeout(function() {
			$("#msg"+rowId).html("");
			$("#delete"+rowId).toggleClass("invisible");
			$("#delete"+rowId).addClass("delete");
           },1000);
	       
 	   }
	}

    function sortTable() {
	   $('#times').find('tr').sortElements(function(a, b){

         return orderedFormat($(a).children('td')[1].textContent) + $(a).children('td')[2].textContent <
                orderedFormat($(b).children('td')[1].textContent) + $(b).children('td')[2].textContent      ? 1 : -1;
       });
	}

	updateDate();
	$("#time-range").keydown(function(event) {
	// Allow: backspace, delete, tab, escape, enter, F5
	if ( event.keyCode == 46 || event.keyCode == 8 || event.keyCode == 9 || event.keyCode == 27 || event.keyCode == 13 || event.keyCode == 116 ||
		 // Allow: Ctrl+A
		(event.keyCode == 65 && event.ctrlKey === true) || 
		 // Allow: home, end, left, right
		(event.keyCode >= 35 && event.keyCode <= 40)) {
		     // let it happen, don't do anything
		     if (event.keyCode==38)
		         nextDate();
		     else if (event.keyCode==40)
				previousDate();
		     else if (event.keyCode == 13)
		        submitTime($("#time-range").val());
		     return;
	}
	else {
		// Ensure that it is a number and stop the keypress
		if (event.shiftKey || (event.keyCode < 48 || event.keyCode > 57) && (event.keyCode < 96 || event.keyCode > 105 )) {
		    event.preventDefault(); 
		}   
	}
	});


    refresh();
  });

  </script>
</head>
<body>
 
<div class="ui-widget">
  <div class="links">
      <div id="refresh" class="link">Refresh</div>
      <div id="report" class="link">Report</div>
	  <div id="settings" class="link">Settings</div>
  </div>

  <div id="main">
	  <img id="working" class="invisible" src="image/spinner.gif"/><br/>
	  <label id="date" for="tags">12/05/2013: </label>
	  <input id="time-range" />
	  <table id="times">
	  </table>
      <div id="more">More</div>
  </div>

</div>
 
 
</body>
</html>
